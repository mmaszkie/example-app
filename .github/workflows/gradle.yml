name: Build and run tests (CI)

on: [push, workflow_dispatch]

jobs:
  build_and_run_tests:
    name: CI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Setup JDK
        uses: actions/setup-java@v2
        with:
          java-version: '17'
          distribution: 'adopt'

      - name: Allow gradlew execution
        run: chmod +x gradlew

      - name: Install k6
        run: |
          curl https://github.com/loadimpact/k6/releases/download/v0.26.2/k6-v0.26.2-linux64.tar.gz -L | tar xvz --strip-components 1

      - name: Run application
        run: ./gradlew bootRun --args=--spring.profiles.active=local &

      - name: Wait for application to start
        run: sleep 30

      - name: Run performance tests
        run: ./k6 run src/main/resources/test.js --out json=results.json

      - name: Upload performance test results
        uses: actions/upload-artifact@v3
        with:
          name: k6-report
          path: results.json